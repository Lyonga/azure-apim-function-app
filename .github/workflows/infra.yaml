name: Deploy Terraform modules

on:
  push:
    branches:
      - main
    paths:
      - "azure-enterprise-terraform/**"
  workflow_dispatch:
    inputs:
      stack_path:
        description: "Terraform working dir (e.g. terraform/stacks/dev/platform)"
        required: true
        default: "terraform/stacks/dev/platform"
      force_unlock:
        description: "Force unlock state (ONLY if you know it's stale)"
        type: boolean
        required: false
        default: false
      lock_id:
        description: "Lock ID from the error output (GUID)"
        required: false
        default: ""

jobs:
  terraform:
    runs-on: ubuntu-latest

    # Prevent concurrent runs from fighting over the same state
    concurrency:
      group: tf-${{ github.ref }}-${{ inputs.stack_path }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.ARM_CLIENT_ID }}" \
            -p "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"
          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Terraform Init
        working-directory: ${{ inputs.stack_path }}
        run: terraform init -upgrade

      - name: Force unlock (manual use)
        if: ${{ inputs.force_unlock == true && inputs.lock_id != '' }}
        working-directory: ${{ inputs.stack_path }}
        run: terraform force-unlock -force "${{ inputs.lock_id }}"

      - name: Terraform Plan
        working-directory: ${{ inputs.stack_path }}
        run: terraform plan -lock-timeout=5m
      - name: Terraform Destroy
        working-directory: ${{ inputs.stack_path }}
        run: terraform destroy -lock-timeout=5m -auto-approve

      - name: Terraform Init Modules
        working-directory: ./azure-enterprise-terraform/terraform/stacks/dev/platform
        run: terraform init -upgrade

    #   - name: Force unlock (manual use)
    #     if: ${{ github.event_name == 'workflow_dispatch' && inputs.unlock == 'true' }}
    #     run: terraform force-unlock -force 81aab101-491e-be8d-de94-4ad3e39a3acb

      - name: Terraform Plan Modules
        working-directory: ./azure-enterprise-terraform/terraform/stacks/dev/platform
        run: terraform plan -lock-timeout=5m -vars-file=dev.auto.tfvars

      - name: Terraform Apply Modules
        working-directory: ./azure-enterprise-terraform/terraform/stacks/dev/platform
        run: terraform apply -lock-timeout=5m -auto-approve -vars-file=dev.auto.tfvars